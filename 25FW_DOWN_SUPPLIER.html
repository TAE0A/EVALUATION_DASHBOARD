<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>25FW 다운 공급처 평가 대시보드</title>

<!-- Chart.js + Datalabels (CDN + fallback) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>if(typeof window.Chart==='undefined'){document.write('<script src="https://unpkg.com/chart.js@4.4.1/dist/chart.umd.min.js"><\/script>');}</script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script>if(typeof window.ChartDataLabels==='undefined'){document.write('<script src="https://unpkg.com/chartjs-plugin-datalabels@2.2.0"><\/script>');}</script>

<style>
  :root{
    --mlb-navy:#0b1f44; --mlb-gray-900:#0f172a; --mlb-gray-700:#334155; --mlb-gray-500:#64748b; --mlb-gray-300:#e5e7eb; --mlb-bg:#f5f7fb; --accent:#f59e0b;
    --v1:#1f3e87; --v2:#3856a3; --v3:#5f78b9; --v4:#8ca2d4;
    --q1:#173b7a; --q2:#2153a8; --q3:#3a6fd6; --q4:#6b8eea; --q5:#9fb5ef;
    --price:#355a8b;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--mlb-bg);color:var(--mlb-gray-900);font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,'Apple SD Gothic Neo','Malgun Gothic',sans-serif}
  header{padding:14px 18px;border-bottom:1px solid var(--mlb-gray-300);background:#fff;position:sticky;top:0;z-index:10}
  header .title{margin:0;font-size:16px;font-weight:800;color:var(--mlb-navy)}
  header .desc{margin:4px 0 0;color:var(--mlb-gray-700);font-size:12px}
  .wrap{max-width:1200px;margin:18px auto;padding:0 14px 42px}
  .grid{display:grid;gap:14px}
  .g-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .g-4{grid-template-columns:repeat(4,minmax(0,1fr))}
  @media (max-width:920px){.g-4{grid-template-columns:repeat(2,minmax(0,1fr))}}
  @media (max-width:680px){.g-2,.g-4{grid-template-columns:1fr}}
  .card{background:#fff;border:1px solid var(--mlb-gray-300);border-radius:14px;box-shadow:0 6px 22px rgba(16,24,40,.06);padding:14px}
  .card h3{margin:0 0 10px;font-size:14px}
  .kpi{display:flex;align-items:center;min-height:48px}
  .kpi .val{font-size:20px;font-weight:800;color:var(--mlb-navy)}
  .tabs{display:flex;gap:8px;margin:12px 0 6px}
  .tab-btn{appearance:none;border:1px solid var(--mlb-gray-300);background:#fff;padding:8px 12px;border-radius:10px;font-size:12px;color:var(--mlb-gray-700);cursor:pointer}
  .tab-btn.active{background:var(--mlb-navy);color:#fff;border-color:var(--mlb-navy)}
  .section{display:none}.section.active{display:block}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--mlb-gray-300);padding:8px 9px;font-size:12px;text-align:center}
  th{background:#f8fafc}
  caption{caption-side:top;text-align:left;font-weight:700;margin-bottom:6px;color:var(--mlb-gray-700)}
  canvas{display:block;width:100%}
  .chart-xs{height:230px !important}
  .chart-sm{height:230px !important}
  .chart-md{height:260px !important}
  .chart-lg{ height: 460px !important; }  /* 단가 추이 그래프 전용(더 크게) */

</style>
</head>
<body>
<header>
  <h1 class="title">25FW 다운 공급처 평가 대시보드</h1>
  <p class="desc">최종 종합 = 품질 50% + 가격 25% + 정성 25% (COVER 기준, 합격률은 모두 “2차 기준”)</p>
</header>

<div class="wrap">
  <!-- KPIs -->
  <section class="grid g-4">
    <div class="card"><h3>최종 1위 공급처</h3><div class="kpi"><div class="val" id="kpiTop">-</div></div></div>
    <div class="card"><h3>품질 Top</h3><div class="kpi"><div class="val" id="kpiQ">-</div></div></div>
    <div class="card"><h3>가격 Top</h3><div class="kpi"><div class="val" id="kpiP">-</div></div></div>
    <div class="card"><h3>정성평가 Top</h3><div class="kpi"><div class="val" id="kpiS">-</div></div></div>
  </section>

  <section class="grid g-2" style="margin-top:14px">
    <div class="card"><h3>최종 종합점수 (100점)</h3><canvas id="finalScore" class="chart-sm"></canvas></div>
    <div class="card"><h3>항목별 점수 비교 (품질 · 가격 · 정성)</h3><canvas id="byPillar" class="chart-sm"></canvas></div>
  </section>

  <div class="tabs">
    <button class="tab-btn active" data-target="#sec-quality">품질</button>
    <button class="tab-btn" data-target="#sec-price">가격</button>
    <button class="tab-btn" data-target="#sec-subj">정성평가</button>
  </div>

  <!-- 품질 -->
  <section id="sec-quality" class="section active">
    <div class="card"><h3>품질 평가 상세 (100점)</h3><canvas id="qualityStack" class="chart-md"></canvas></div>

    <div class="grid g-2" style="margin-top:14px">
      <div class="card">
        <h3>세부항목 1 — 솜털함량 평균값</h3>
        <div class="desc" style="font-size:12px;color:var(--mlb-gray-500);margin-bottom:6px">합격 기준: GB &amp; KS ≥ 80</div>
        <canvas id="duvetContentStack" class="chart-xs"></canvas>
      </div>
      <div class="card">
        <h3>세부항목 2 — 충전도(필파워) 평균값</h3>
        <div class="desc" style="font-size:12px;color:var(--mlb-gray-500);margin-bottom:6px">합격 기준: GB ≥ 650, KS ≥ 120</div>
        <canvas id="fillPowerStack" class="chart-xs"></canvas>
      </div>
    </div>

    <div class="grid g-2" style="margin-top:14px">
      <div class="card"><h3>세부항목 3 — 원자재 다운테스트 <b>합격률</b></h3><canvas id="downPass" class="chart-xs"></canvas></div>
      <div class="card"><h3>세부항목 4 — 완제품 파기테스트 <b>합격률</b></h3><canvas id="readyPass" class="chart-xs"></canvas></div>
    </div>

    <div class="card" style="margin-top:14px">
      <h3>충전도 상세</h3>
      <table>
        <caption>GB(IDFB) / KS 충전도 평균</caption>
        <thead><tr><th>공급처</th><th>GB</th><th>KS</th></tr></thead>
        <tbody id="fillTable"></tbody>
      </table>
    </div>
  </section>

  <!-- 가격 -->
  <section id="sec-price" class="section">
    <div class="grid g-2">
      <div class="card"><h3>가격 배점 (100점)</h3><canvas id="priceChart" class="chart-sm"></canvas></div>
      <div class="card"><h3>최저 단가 제안 횟수</h3><canvas id="proposalChart" class="chart-sm"></canvas><div class="desc" style="font-size:12px;color:var(--mlb-gray-500);margin-top:6px">※ XIN TANG은 항상 최저 → 카운트 제외</div></div>
    </div>
<!-- 26FW 단가 추이 -->
<div class="card" style="margin-top:14px">
  <h3>26FW 단가 추이 — DUCK 8020 (USD)</h3>
  <canvas id="priceTrendDuck" class="chart-lg"></canvas>
</div>

<div class="card" style="margin-top:14px">
  <h3>26FW 단가 추이 — GOOSE 8020 (USD)</h3>
  <canvas id="priceTrendGoose" class="chart-lg"></canvas>
</div>

  </section>

  <!-- 정성평가 -->
  <section id="sec-subj" class="section">
    <div class="card" style="margin-bottom:14px">
      <h3>정성평가 상세 (100점)</h3>
      <canvas id="subjStack" class="chart-md"></canvas>
    </div>
    <div class="card">
      <h3>정성평가</h3>
      <table>
        <caption>정성평가 세부점수 및 총점(100)</caption>
        <thead><tr><th>항목</th><th>XIN TANG</th><th>신주원</th><th>제이앤피</th><th>프라우덴</th></tr></thead>
        <tbody id="subjTable"></tbody>
      </table>
    </div>
  </section>
</div>

<script>
'use strict';

(function(){
  if(typeof window.Chart==='undefined'){ alert('Chart.js 로딩 실패'); return; }

  const hasDL = !!window.ChartDataLabels;
  if (hasDL) { try { Chart.register(window.ChartDataLabels); } catch(e){} }

  /* === 스택 전체 외곽선 플러그인 (1등 강조) === */
 // ── 막대 '실제 폭/좌표'로 그리는 U-자 외곽선 플러그인
const stackOutlinePlugin = {
  id: 'stackOutline',
  afterDraw(chart, args, opts) {
    const {
      index,
      color = '#f59e0b',
      lineWidth = 3,   // 얇게
      radius = 10,
      padding = 0,     // 막대에 '딱' 붙도록
      uShape = true
    } = opts || {};
    if (index == null) return;

    const xScale = chart.scales.x, yScale = chart.scales.y;
    if (!xScale || !yScale) return;

    // 실제로 그려진 바 엘리먼트들의 좌/우, 상/하를 모아 U-자 외곽선 캡쳐
    let left = Infinity, right = -Infinity, top = Infinity, bottom = -Infinity, found = false;

    chart.data.datasets.forEach((ds, di) => {
      const meta = chart.getDatasetMeta(di);
      if (!meta || meta.hidden || ds.type === 'line') return; // TOTAL 라벨용 라인 제외
      const el = meta.data?.[index];
      if (!el || typeof el.getProps !== 'function') return;

      const p = el.getProps(['x','y','base','width'], true);
      if (p && isFinite(p.x) && isFinite(p.width)) {
        const l = p.x - p.width / 2;
        const r = p.x + p.width / 2;
        left  = Math.min(left,  l);
        right = Math.max(right, r);
        top   = Math.min(top,   Math.min(p.y, p.base));
        bottom= Math.max(bottom,Math.max(p.y, p.base));
        found = true;
      }
    });
    if (!found) return;

    // 패딩 및 차트 영역 보정
    const area = chart.chartArea;
    const L = Math.max(left  - padding, area.left  + 1);
    const R = Math.min(right + padding, area.right - 1);
    const T = Math.max(top   - padding, area.top   + 1);
    const B = Math.min(bottom+ padding, area.bottom- 1);

    // 픽셀 크리스프 처리(미세 블러 방지)
    const crisp = (v)=> Math.round(v) + ((lineWidth % 2) ? 0.5 : 0);

    const ctx = chart.ctx, r = radius;
    ctx.save();
    ctx.strokeStyle = color;
    ctx.lineWidth = lineWidth;

    ctx.beginPath();
    if (uShape) {
      // U자(상단/좌/우만)
      ctx.moveTo(crisp(R), crisp(B));
      ctx.lineTo(crisp(R), crisp(T + r));
      ctx.quadraticCurveTo(crisp(R), crisp(T), crisp(R - r), crisp(T));
      ctx.lineTo(crisp(L + r), crisp(T));
      ctx.quadraticCurveTo(crisp(L), crisp(T), crisp(L), crisp(T + r));
      ctx.lineTo(crisp(L), crisp(B));
    } else {
      // 사각형 전체
      ctx.moveTo(crisp(L + r), crisp(T));
      ctx.lineTo(crisp(R - r), crisp(T));
      ctx.quadraticCurveTo(crisp(R), crisp(T), crisp(R), crisp(T + r));
      ctx.lineTo(crisp(R), crisp(B - r));
      ctx.quadraticCurveTo(crisp(R), crisp(B), crisp(R - r), crisp(B));
      ctx.lineTo(crisp(L + r), crisp(B));
      ctx.quadraticCurveTo(crisp(L), crisp(B), crisp(L), crisp(B - r));
      ctx.lineTo(crisp(L), crisp(T + r));
      ctx.quadraticCurveTo(crisp(L), crisp(T), crisp(L + r), crisp(T));
    }
    ctx.stroke();
    ctx.restore();
  }
};
Chart.register(stackOutlinePlugin);

// ▶ 오른쪽 끝에 공급처명 그려주는 플러그인 (차트 오른쪽 패딩에 직접 텍스트 렌더)
const rightEndNames = {
  id: 'rightEndNames',
  afterDatasetsDraw(chart, args, opts) {
    if (!opts || !opts.enabled) return;

    const ctx = chart.ctx;
    const area = chart.chartArea;
    const yScale = chart.scales.y;
    const labels = chart.data.labels;
    if (!yScale || !labels?.length) return;

    const lastIdx = labels.length - 1;

    // 각 데이터셋의 마지막 유효값(y 픽셀) 수집
    const items = [];
    chart.data.datasets.forEach((ds, i) => {
      const meta = chart.getDatasetMeta(i);
      if (!meta || meta.hidden) return;
      if (/\(라벨\)$/.test(ds.label)) return; // 혹시 남아 있으면 무시
      const arr = ds.data;
      if (!Array.isArray(arr)) return;

      let j = lastIdx;
      while (j >= 0 && (arr[j] == null || Number.isNaN(arr[j]))) j--;
      if (j < 0) return;

      const v = +arr[j];
      items.push({
        name: ds.label,
        color: ds.borderColor || '#333',
        y: yScale.getPixelForValue(v)
      });
    });

    // y 겹침 해소(픽셀 기준 간격 보장)
    items.sort((a,b) => a.y - b.y);
    const minGap = 14; // px
    for (let k = 1; k < items.length; k++) {
      if (items[k].y - items[k-1].y < minGap) items[k].y = items[k-1].y + minGap;
    }
    // 상하 범위 제한
    items.forEach(it => {
      it.y = Math.max(area.top + 8, Math.min(area.bottom - 8, it.y));
    });

    // 텍스트 렌더 (차트 오른쪽 패딩 내부)
    ctx.save();
    ctx.textAlign = 'left';
    ctx.textBaseline = 'middle';
    ctx.font = '700 11px Pretendard, system-ui, -apple-system, "Segoe UI", Roboto, Arial';
    const dx = (opts.offsetRight ?? 8);
    items.forEach(it => {
      ctx.fillStyle = it.color;
      ctx.fillText(it.name, area.right + dx, it.y);
    });
    ctx.restore();
  }
};
Chart.register(rightEndNames);


  /* === 유틸/상수 === */
  const cssVar = (n)=> getComputedStyle(document.documentElement).getPropertyValue(n).trim();
  const vendorColors=[cssVar('--v1'),cssVar('--v2'),cssVar('--v3'),cssVar('--v4')];
  const qColors=[cssVar('--q1'),cssVar('--q2'),cssVar('--q3'),cssVar('--q4'),cssVar('--q5')];
  const priceColor=cssVar('--price');
  const gridOpt={ grid:{ color:"rgba(2,6,23,0.10)" }, ticks:{ color: cssVar('--mlb-gray-700'), font:{ size:11 } } };
  const xTicksStrong = { ticks:{ color: cssVar('--mlb-gray-900'), font:{ size:12, weight:700 } } };
  const ranks=(arr)=>{ const s=[...arr].map((v,i)=>({v,i})).sort((a,b)=>b.v-a.v); const r={}; let k=1,p=null;
    s.forEach((o,i)=>{ if(p!==null && o.v<p) k=i+1; r[o.i]=k; p=o.v; }); return arr.map((_,i)=>r[i]); };
  const topBorderArray=(data)=>{ const m=Math.max(...data); return data.map(v=> v===m ? 4 : 1); };
  const topBorderColorArray=(data, fallback)=>{ const m=Math.max(...data); return data.map(v=> v===m ? cssVar('--accent') : fallback); };
  const makeInsideLabel=(opts={})=>{
    const base={ legend:{ labels:{ color:cssVar('--mlb-gray-900'), boxWidth:12, usePointStyle:true, pointStyle:"circle", font:{size:12} } }, tooltip:{enabled:true}};
    if(!hasDL) return base;
    const isPercent=!!opts.isPercent, onlyRank=!!opts.onlyRank;
    return { ...base, datalabels:{
      color:"#f8fafc", font:{weight:800,size:12}, anchor:"center", align:"center",
      formatter:(v,ctx)=> onlyRank ? `${ranks(ctx.dataset.data)[ctx.dataIndex]}위` : (typeof v==="number"?(isPercent?`${v.toFixed(1)}%`:`${(+v.toFixed(1))}`):v)
    }};
  };
  const BAR_W90 = {
    categoryPercentage:1, barPercentage:1,
    barThickness:(ctx)=>{ const x=ctx.chart.scales.x; if(!x||x.ticks.length<2) return 60;
      const w=Math.abs(x.getPixelForTick(1)-x.getPixelForTick(0)); return Math.floor(w*0.90); }
  };
  const create=(id,cfg)=> new Chart(document.getElementById(id),cfg);

  /* === 데이터 (2차 기준) === */
  const suppliers = ["XIN TANG","신주원","제이앤피","프라우덴"];

  // 품질 상세(원점수 %) – 시트 캡처 기준
  const pct_downContent = [75, 25, 50, 100]; // 솜털함량(%)
  const pct_fillPower   = [100, 25, 50, 75]; // 충전도(%)
  const pass2_downRaw   = [100, 83, 100, 100]; // 다운 원자재 2차 합격률(%)
  const pass2_ready     = [72.4, 95.4, 90, 80];   // 완제품 파기 2차 합격률(%)

  // (기존 코드와 호환용 별칭)
  const q_downPass  = pass2_downRaw;
  const q_readyPass = pass2_ready;

  // 품질 총점(자동 계산) = 네 항목 % × 0.25 합
  const qualityTotal = suppliers.map((_, i) => +(
    pct_downContent[i]*0.25 +
    pct_fillPower[i]*0.25   +
    q_downPass[i]*0.25      +
    q_readyPass[i]*0.25
  ).toFixed(2));

  // 가격
  const priceScore   = [100, 75, 50, 100];
  const proposalCounts=[0,14,3,18];

  // 정성평가(5점 만점 세부 → 100점 총점 자동 계산)
  const subjDetail = {
    "일정 준수":   [4.0, 4.7, 5.0, 4.7],
    "퀄리티":     [3.0, 2.7, 4.0, 4.0],
    "업무 팔로업": [4.0, 4.3, 4.0, 3.7],
    "HQ 정성평가":[2.0, 2.7, 3.0, 4.3]
  };
  const CRITERIA = ["일정 준수","퀄리티","업무 팔로업","HQ 정성평가"];
  const subjScore = suppliers.map((_, i) =>
    +(CRITERIA.reduce((sum, key) => sum + subjDetail[key][i] * 5, 0).toFixed(1))
  );

  // 최종 종합(품질 50% + 가격 25% + 정성 25%)
  const finalScore = suppliers.map((_,i)=> +(qualityTotal[i]*0.50 + priceScore[i]*0.25 + subjScore[i]*0.25).toFixed(2));

  /* === KPI === */
  document.getElementById('kpiTop').textContent = suppliers[finalScore.indexOf(Math.max(...finalScore))];
  document.getElementById('kpiQ').textContent   = suppliers[qualityTotal.indexOf(Math.max(...qualityTotal))];
  document.getElementById('kpiP').textContent   = suppliers[priceScore.indexOf(Math.max(...priceScore))];
  document.getElementById('kpiS').textContent   = suppliers[subjScore.indexOf(Math.max(...subjScore))];

  /* === 그래프들 === */

  // 최종 종합
  create("finalScore", {
    type:"bar",
    data:{ labels:suppliers, datasets:[{ label:"최종 점수", data:finalScore, backgroundColor: vendorColors,
      borderColor: topBorderColorArray(finalScore,'#fff'), borderWidth: topBorderArray(finalScore), borderRadius:8 }]},
    options:{ responsive:true, maintainAspectRatio:false,
      scales:{ x:{...gridOpt, ...xTicksStrong}, y:{...gridOpt, beginAtZero:true, max:100} }, plugins: makeInsideLabel() }
  });

  // 항목별(품질/가격/정성)
  create("byPillar", {
    type:"bar",
    data:{ labels:suppliers, datasets:[
      { label:"품질", data:qualityTotal, backgroundColor:qColors[0], borderRadius:8,
        borderColor: topBorderColorArray(qualityTotal,qColors[0]), borderWidth: topBorderArray(qualityTotal) },
      { label:"가격", data:priceScore,   backgroundColor:qColors[2], borderRadius:8,
        borderColor: topBorderColorArray(priceScore,qColors[2]),   borderWidth: topBorderArray(priceScore) },
      { label:"정성", data:subjScore,    backgroundColor:qColors[4], borderRadius:8,
        borderColor: topBorderColorArray(subjScore,qColors[4]),    borderWidth: topBorderArray(subjScore) }
    ]},
    options:{ responsive:true, maintainAspectRatio:false,
      scales:{ x:{...gridOpt, ...xTicksStrong}, y:{...gridOpt, beginAtZero:true, max:100} }, plugins: makeInsideLabel({onlyRank:true}) }
  });

  /* ── 품질 평가 상세 (스택) + 1등 외곽선 + 상단 총점/순위 ── */
  (() => {
    const to25 = arr => arr.map(v => +(v * 0.25).toFixed(1));
    const sDownContent = to25(pct_downContent);
    const sFillPower   = to25(pct_fillPower);
    const sDownPass    = to25(q_downPass);     // 2차 기준
    const sBreak       = to25(q_readyPass);    // 2차 기준

    const totals = sDownContent.map((_, i) =>
      +(sDownContent[i] + sFillPower[i] + sDownPass[i] + sBreak[i]).toFixed(1)
    );
    const ranksQ = ranks(totals);
    const topIdx = totals.indexOf(Math.max(...totals));

    const WIDE = BAR_W90;

    new Chart(document.getElementById("qualityStack"), {
      type: "bar",
      data: {
        labels: suppliers,
        datasets: [
          { label:"솜털함량 (25점)",                   data:sDownContent, backgroundColor:qColors[0], borderRadius:8, ...WIDE },
          { label:"충전도 (25점)",                     data:sFillPower,   backgroundColor:qColors[1], borderRadius:8, ...WIDE },
          { label:"다운테스트 합격률 (25점)",      data:sDownPass,    backgroundColor:qColors[2], borderRadius:8, ...WIDE },
          { label:"완제품 파기 합격률 (25점)",     data:sBreak,       backgroundColor:qColors[3], borderRadius:8, ...WIDE },
          { label:"TOTAL", data:totals, type:"line", order:5, pointRadius:0, borderWidth:0,
            datalabels: hasDL ? {
              display:true, clip:false, clamp:true, offset:-2,
              color: cssVar('--mlb-gray-900'),
              font:(ctx)=>({ weight: ranksQ[ctx.dataIndex]===1 ? 900 : 600, size:12 }),
              anchor:"end", align:"top",
              formatter:(v,ctx)=> `${v.toFixed(1)}, ${ranksQ[ctx.dataIndex]}위`
            } : undefined
          }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        scales: {
          x: { ...gridOpt, ...xTicksStrong, stacked: true },
          y: { ...gridOpt, stacked: true, beginAtZero: true, max: 100 }
        },
        plugins: {
          ...makeInsideLabel(),
          legend: { labels: { color: cssVar('--mlb-gray-900'), filter:(i)=> i.text!=="TOTAL" } },
          tooltip: { enabled: true },
          stackOutline:{ index: topIdx, color: cssVar('--accent'), lineWidth: 4, radius: 10, padding: 0, uShape: true } // ★
}
      }
    });
  })();

/* ── 세부항목 1: 솜털함량 (GB/KS 스택, TOTAL 라벨, 외곽선=막대 전체) ── */
(() => {
  const fluffGB=[81.6,79.0,78.3,82.2],  fluffKS=[80.6,81.7,83.0,84.0];
  const totals = fluffGB.map((v,i)=> +(v + fluffKS[i]).toFixed(1));
  const r = ranks(totals);
  const topIdx = totals.indexOf(Math.max(...totals));
  const yMax = 190;

  new Chart(document.getElementById("duvetContentStack"),{
    type:"bar",
    data:{
      labels:suppliers,
      datasets:[
        {label:"GB", data:fluffGB, backgroundColor:"#305aa8", stack:"s",
         borderRadius:8, borderWidth:0, borderColor:"transparent", borderSkipped:false,
         ...BAR_W90,
         datalabels: hasDL ? {
           display:true, color:"#f8fafc", font:{weight:700, size:13}, anchor:"center", align:"center",
           formatter:(v)=> `GB ${Number(v).toFixed(1)}`
         } : undefined
        },
        {label:"KS", data:fluffKS, backgroundColor:"#6b8eea", stack:"s",
         borderRadius:8, borderWidth:0, borderColor:"transparent", borderSkipped:false,
         ...BAR_W90,
         datalabels: hasDL ? {
           display:true, color:"#f8fafc", font:{weight:700, size:13}, anchor:"center", align:"center",
           formatter:(v)=> `KS ${Number(v).toFixed(1)}`
         } : undefined
        },
        {label:"TOTAL", data:totals, type:"line", order:3, pointRadius:0, borderWidth:0,
         datalabels: hasDL ? {
           display:true, clip:false, clamp:true, offset:-2,
           color: cssVar('--mlb-gray-900'),
           font:(ctx)=>({ weight: r[ctx.dataIndex]===1 ? 900 : 600, size:12 }),
           anchor:"end", align:"top",
           formatter:(v, ctx)=> `${Number(v).toFixed(1)} ${r[ctx.dataIndex]}위`
         } : undefined
        }
      ]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      layout:{ padding:{ top: 24 } },
      scales:{
        x:{...gridOpt, ...xTicksStrong, stacked:true},
        y:{...gridOpt, stacked:true, beginAtZero:true, max:yMax, ticks:{ stepSize:50 } }
      },
      plugins:{
        legend:{ labels:{ color:cssVar('--mlb-gray-900'), filter:(i)=> i.text!=="TOTAL" } },
        tooltip:{ enabled:true },
        // ★ 스택 전체 외곽선(1등)
        stackOutline:{ index: topIdx, color: cssVar('--accent'), lineWidth: 4, radius: 10, padding: 0, uShape: true } // ★
}
    }
  });
})();


 /* ── 세부항목 2: 충전도 (GB/KS 스택, TOTAL 라벨, 외곽선=막대 전체) ── */
(() => {
  const fillGB=[666.8,643.0,643.0,661.3], fillKS=[134.6,135.0,135.5,137.9];
  const totals = fillGB.map((v,i)=> +(v + fillKS[i]).toFixed(1));
  const r = ranks(totals);
  const topIdx = totals.indexOf(Math.max(...totals));
  const yMax = 950;

  new Chart(document.getElementById("fillPowerStack"),{
    type:"bar",
    data:{
      labels:suppliers,
      datasets:[
        { label:"GB", data:fillGB, backgroundColor:"#0f58a6", stack:"s",
          borderRadius:8, borderWidth:0, borderColor:"transparent", borderSkipped:false,
          ...BAR_W90,
          datalabels: hasDL ? {
            display:true, color:"#f8fafc", font:{weight:700, size:13}, anchor:"center", align:"center",
            formatter:(v)=> `GB ${Number(v).toFixed(1)}`
          } : undefined
        },
        { label:"KS", data:fillKS, backgroundColor:"#5e84d6", stack:"s",
          borderRadius:8, borderWidth:0, borderColor:"transparent", borderSkipped:false,
          ...BAR_W90,
          datalabels: hasDL ? {
            display:true, color:"#f8fafc", font:{weight:700, size:13}, anchor:"center", align:"center",
            formatter:(v)=> `KS ${Number(v).toFixed(1)}`
          } : undefined
        },
        { label:"TOTAL", data:totals, type:"line", order:3, pointRadius:0, borderWidth:0,
          datalabels: hasDL ? {
            display:true, clip:false, clamp:true, offset:-2, color: cssVar('--mlb-gray-900'),
            font:(ctx)=>({ weight: r[ctx.dataIndex]===1 ? 900 : 600, size:12 }),
            anchor:"end", align:"top", formatter:(v, ctx)=> `${Number(v).toFixed(1)} ${r[ctx.dataIndex]}위`
          } : undefined
        }
      ]
    },
    options:{
      responsive:true, maintainAspectRatio:false, layout:{ padding:{ top: 24 } },
      scales:{ x:{ ...gridOpt, ...xTicksStrong, stacked:true }, y:{ ...gridOpt, stacked:true, beginAtZero:true, max:yMax, ticks:{ stepSize:50 } } },
      plugins:{
        legend:{ labels:{ color: cssVar('--mlb-gray-900'), filter:(i)=> i.text!=="TOTAL" } },
        tooltip:{ enabled:true },
        // ★ 스택 전체 외곽선(1등)
        stackOutline:{ index: topIdx, color: cssVar('--accent'), lineWidth: 4, radius: 10, padding: 0, uShape: true } // ★
}
    }
  });
})();


  // 세부항목 3/4 (2차 기준 합격률)
  create("downPass", {
    type:"bar",
    data:{ labels:suppliers, datasets:[{ label:"다운 원자재 합격률", data:q_downPass,
      backgroundColor: vendorColors, borderRadius:8, ...BAR_W90,
      borderColor: topBorderColorArray(q_downPass,'#fff'), borderWidth: topBorderArray(q_downPass) }]},
    options:{ responsive:true, maintainAspectRatio:false, scales:{ x:{...gridOpt, ...xTicksStrong}, y:{...gridOpt, beginAtZero:true, max:100} }, plugins: makeInsideLabel({isPercent:true}) }
  });
  create("readyPass", {
    type:"bar",
    data:{ labels:suppliers, datasets:[{ label:"완제품 파기 합격률", data:q_readyPass,
      backgroundColor: vendorColors, borderRadius:8, ...BAR_W90,
      borderColor: topBorderColorArray(q_readyPass,'#fff'), borderWidth: topBorderArray(q_readyPass) }]},
    options:{ responsive:true, maintainAspectRatio:false, scales:{ x:{...gridOpt, ...xTicksStrong}, y:{...gridOpt, beginAtZero:true, max:100} }, plugins: makeInsideLabel({isPercent:true}) }
  });

/* ── 정성평가 스택 (막대 90% 폭 + 1등 U자 외곽선 + 상단 총점·순위 라벨) ── */
(() => {
  const CRITERIA = ["일정 준수","퀄리티","업무 팔로업","HQ 정성평가"];
  const to25 = arr => arr.map(v => +(v * 5).toFixed(1)); // 5점 → 25점 환산
  const dataByCrit = CRITERIA.map(k => to25(subjDetail[k]));

  // 각 공급처의 총점(100만점)과 순위
  const stackTotals = dataByCrit[0].map((_, i) =>
    dataByCrit.reduce((sum, arr) => sum + arr[i], 0)
  );
  const ranksS = ranks(stackTotals);
  const topIdx = stackTotals.indexOf(Math.max(...stackTotals));

  // 4개 세그먼트
  const ds = CRITERIA.map((name, i) => ({
    label: `${name} (25점)`,
    data: dataByCrit[i],
    backgroundColor: qColors[i % qColors.length],
    stack: "s",
    borderRadius: 8,
    borderWidth: 0, borderColor: "transparent", borderSkipped: false,
    ...BAR_W90,
    datalabels: hasDL ? {
      display: true, color: "#f8fafc",
      font: { weight: 800, size: 12 },
      anchor: "center", align: "center",
      formatter: v => Number(v).toFixed(1)
    } : undefined
  }));

  // ★ 상단 총점·순위 라벨 전용 dataset (선/포인트 없이 라벨만)
  ds.push({
    label: "TOTAL",
    data: stackTotals,
    type: "line", order: 5, pointRadius: 0, borderWidth: 0,
    datalabels: hasDL ? {
      display: true, clip: false, clamp: true, offset: -2,
      color: cssVar('--mlb-gray-900'),
      font: (ctx) => ({ weight: ranksS[ctx.dataIndex] === 1 ? 900 : 600, size: 12 }),
      anchor: "end", align: "top",
      formatter: (v, ctx) => `${(+v).toFixed(1)}, ${ranksS[ctx.dataIndex]}위`
    } : undefined
  });

  new Chart(document.getElementById("subjStack"), {
    type: "bar",
    data: { labels: suppliers, datasets: ds },
    options: {
      responsive: true, maintainAspectRatio: false,
      scales: {
        x: { ...gridOpt, ...xTicksStrong, stacked: true },
        y: { ...gridOpt, stacked: true, beginAtZero: true, max: 100 }
      },
      plugins: {
        ...makeInsideLabel(),
        // TOTAL은 범례에서 숨김
        legend: { labels: { color: cssVar('--mlb-gray-900'), filter: (i) => i.text !== "TOTAL" } },
        tooltip: { enabled: true },
        // U자 외곽선(얇게, 막대에 밀착) – 플러그인은 이미 등록되어 있어야 함
        stackOutline: { index: topIdx, color: cssVar('--accent'), lineWidth: 3, radius: 10, padding: 0, uShape: true }
      }
    }
  });
})();

  // 가격 탭
/* ===== 26FW 단가 추이 (DUCK 8020, GOOSE 8020) — 겹침 방지 + 색상 일치 ===== */
(() => {
  // 공통 X축(주차)
  const priceWeeks = ['6월 4주','7월 1주','7월 2주','7월 3주','7월 4주','7월 5주~8월 1주','8월 2주','8월 3주','8월 4주','8월 5주','9월 1주'];

  // 색상 팔레트(현재 사용 중인 팔레트 그대로)
  const lineColors = ['#2563eb','#16a34a','#ef4444','#92400e','#db2777','#7c3aed','#f1c40f'];

  /* === DUCK 8020 (USD) === */
  const duckVendors = ['FULIDA','FURUIYA','XINTANG','신주원','제이앤피','프라우덴','25FW'];
  const duckData = {
    "FULIDA":  [null,41.7,40.1,40.1,40.1,42.5,42.5,42.5,47.1,47.1,47.1],
    "FURUIYA": [null,46.8,46.8,46.8,46.8,48.6,48.6,48.6,50.6,50.6,50.6],
    "XINTANG": [null,47.0,47.0,47.0,47.0,47.0,47.0,47.0,48.0,48.0,48.0],
    "신주원":    [52.3,52.3,51.8,51.5,52.0,52.5,52.5,52.5,52.5,53.5,54.0],
    "제이앤피":  [42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,42.3,43.3,43.3],
    "프라우덴":  [53.0,52.5,52.5,51.5,49.5,52.0,52.0,53.5,53.5,54.0,54.0],
    "25FW":     [45.0,45.0,45.0,45.0,45.0,45.0,45.0,45.0,45.0,45.0,45.0]
  };

  /* === GOOSE 8020 (USD) === */
  const gooseVendors = ['FULIDA','FURUIYA','XINTANG','신주원','제이앤피','프라우덴','25FW'];
  const gooseData = {
    "FULIDA":  [null,81.1,79.3,79.3,79.3,82.9,82.9,82.9,85.8,85.8,85.8],
    "FURUIYA": [null,82.3,82.3,82.3,82.3,80.3,80.3,80.3,80.3,80.3,80.3],
    "XINTANG": [null,82.0,82.0,82.0,82.0,82.0,82.0,82.0,84.0,84.0,84.0],
    "신주원":    [95.3,95.3,94.3,94.0,88.0,88.0,88.0,88.0,88.0,89.3,89.3],
    "제이앤피":  [83.3,83.3,83.3,83.3,83.3,84.3,84.3,84.3,84.3,85.3,85.3],
    "프라우덴":  [89.0,89.0,89.0,88.0,85.0,87.5,89.0,90.0,89.0,92.0,92.0],
    "25FW":     [88.0,88.0,88.0,88.0,88.0,88.0,88.0,88.0,88.0,88.0,88.0]
  };

  // ── 공급처→색상 매핑(두 그래프 공통 / 팔레트 그대로)
  const allVendors = Array.from(new Set([...duckVendors, ...gooseVendors]));
  const colorMap = {};
  allVendors.forEach((v,i)=> colorMap[v] = lineColors[i % lineColors.length]);

  // 기본 라인 데이터셋(텍스트는 플러그인이 그립니다)
  const mkLineDs = (label, arr) => ({
    label,
    data: Array.isArray(arr) ? arr : new Array(priceWeeks.length).fill(null),
    borderColor: colorMap[label] || lineColors[0],
    backgroundColor: colorMap[label] || lineColors[0],
    borderWidth: 2, tension: 0.25, spanGaps: true,
    pointRadius: 2, pointHoverRadius: 4,
    datalabels: hasDL ? { display:false } : undefined
  });

  const duckDatasets  = duckVendors.map(v => mkLineDs(v, duckData[v]));
  const gooseDatasets = gooseVendors.map(v => mkLineDs(v, gooseData[v]));

  // y축 max (현재 로직 유지)
  const maxOf = (obj) => Math.max(...Object.values(obj).flat().filter(v => v != null));
  const duckYmax  = Math.ceil(maxOf(duckData)  + 1.5);
  const gooseYmax = Math.ceil(maxOf(gooseData) + 3);

  // 공통 옵션 + 오른쪽 이름 플러그인 활성화
  const baseLineOpts = {
    responsive:true, maintainAspectRatio:false,
    scales:{
      x:{ ...gridOpt, ...xTicksStrong },
      y:{ ...gridOpt, beginAtZero:false, ticks:{ callback:(v)=>'$'+v } }
    },
    plugins:{
      legend:{ labels:{ color: cssVar('--mlb-gray-900'), boxWidth:12, usePointStyle:true, pointStyle:'line', font:{size:12} } },
      tooltip:{ enabled:true, callbacks:{ label:(ctx)=> `${ctx.dataset.label}: $${ctx.parsed.y}` } },
      // ▶ 오른쪽 이름 렌더 (여백 110px 기준, 필요하면 조정)
      rightEndNames:{ enabled:true, offsetRight: 10 }
    },
    // ▶ 이름이 들어갈 오른쪽 패딩 넉넉히
    layout:{ padding:{ top: 10, right: 110 } }
  };

  create("priceTrendDuck", {
    type:"line",
    data:{ labels: priceWeeks, datasets: duckDatasets },
    options:{ ...baseLineOpts, scales:{ ...baseLineOpts.scales, y:{ ...baseLineOpts.scales.y, max: duckYmax } } }
  });

  create("priceTrendGoose", {
    type:"line",
    data:{ labels: priceWeeks, datasets: gooseDatasets },
    options:{ ...baseLineOpts, scales:{ ...baseLineOpts.scales, y:{ ...baseLineOpts.scales.y, max: gooseYmax } } }
  });
})();

  create("priceChart", {
    type:"bar",
    data:{ labels:suppliers, datasets:[{ label:"가격 배점 (100점)", data:priceScore, backgroundColor:qColors[2], borderRadius:8, ...BAR_W90 }]},
    options:{ responsive:true, maintainAspectRatio:false, scales:{ x:{...gridOpt, ...xTicksStrong}, y:{...gridOpt, beginAtZero:true, max:100} }, plugins: makeInsideLabel() }
  });
  create("proposalChart", {
    type:"bar",
    data:{ labels:suppliers, datasets:[{ label:"최저 단가 제안 횟수", data:proposalCounts, backgroundColor:priceColor, borderRadius:8, ...BAR_W90 }]},
    options:{ responsive:true, maintainAspectRatio:false, scales:{ x:{...gridOpt, ...xTicksStrong}, y:{...gridOpt, beginAtZero:true} }, plugins: makeInsideLabel() }
  });

  // 표 렌더
  (function(){
    const gbIDFB=[666.8, 643.0, 643.0, 661.2], ksFill=[134.6,135.0,135.5,137.9];
    const fillTbody=document.getElementById("fillTable");
    suppliers.forEach((s,i)=> fillTbody.insertAdjacentHTML('beforeend', `<tr><td>${s}</td><td>${gbIDFB[i]}</td><td>${ksFill[i]}</td></tr>`));
    const tbody=document.getElementById("subjTable");
    const row=(name, arr)=> `<tr><td>${name}</td>${arr.map(v=>`<td>${v}</td>`).join('')}</tr>`;
    tbody.innerHTML =
      row('일정 준수',   subjDetail["일정 준수"]) +
      row('퀄리티',     subjDetail["퀄리티"]) +
      row('업무 팔로업', subjDetail["업무 팔로업"]) +
      row('HQ 정성평가',subjDetail["HQ 정성평가"]) +
      row('<b>정성 총점(100)</b>', subjScore.map(v=>Number(v).toFixed(1)));
  })();

  // 탭 토글
  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
      btn.classList.add('active');
      document.querySelector(btn.dataset.target).classList.add('active');
    });
  });
})();
</script>
</body>
</html>
